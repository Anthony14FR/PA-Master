#!/bin/sh

echo "Running API checks..."

if [ ! -d "api" ]; then
    echo "API directory not found!"
    exit 1
fi

cd api

if [ ! -d "vendor" ]; then
    echo "Run 'composer install' in api/ first"
    exit 1
fi

echo "Running Pint..."

cd ..
git diff --name-only > /tmp/before_pint
cd api

vendor/bin/pint -v
PINT_EXIT_CODE=$?

cd ..
git diff --name-only > /tmp/after_pint

PINT_MODIFIED=$(comm -13 /tmp/before_pint /tmp/after_pint)

if [ -n "$PINT_MODIFIED" ]; then
    echo "Pint has modified files, adding them to commit:"
    echo "$PINT_MODIFIED"
    echo "$PINT_MODIFIED" | xargs git add
fi

rm -f /tmp/before_pint /tmp/after_pint

cd api

if [ $PINT_EXIT_CODE -ne 0 ]; then
    echo "❌ Pint failed"
    exit 1
fi

echo "Running PHPStan..."
if ! vendor/bin/phpstan analyse --memory-limit=2G; then
    echo "❌ PHPStan failed"
    exit 1
fi

cd ..

echo "Checks passed"
exit 0