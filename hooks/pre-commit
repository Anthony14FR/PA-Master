#!/bin/sh

BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

if [ "$BRANCH_NAME" = "HEAD" ]; then
    exit 0
fi

VALID_BRANCH_PATTERN="^(feature|fix)/(api|web)/.+"

if ! echo "$BRANCH_NAME" | grep -qE "$VALID_BRANCH_PATTERN"; then
    echo "‚ùå Nom de branche invalide: $BRANCH_NAME"
    echo ""
    echo "Le nom de la branche doit respecter le format:"
    echo "  - feature/api/description"
    echo "  - feature/web/description"
    echo "  - fix/api/description"
    echo "  - fix/web/description"
    echo ""
    echo "Pour renommer votre branche actuelle:"
    echo "   git branch -m feature/api/description"
    echo ""
    echo "‚ùå Nom de branche invalide: $BRANCH_NAME"
    echo "üòé Sign√©: le petit blond relou üòò"
    exit 1
fi

echo "‚úÖ Nom de branche valide: $BRANCH_NAME bravo ti√© le goat"

echo "Running API checks..."

if [ ! -d "api" ]; then
    echo "API directory not found!"
    exit 1
fi

cd api

if [ ! -d "vendor" ]; then
    echo "Run 'composer install' in api/ first"
    exit 1
fi

echo "Running Pint..."

cd ..
git diff --name-only > /tmp/before_pint
cd api

vendor/bin/pint -v
PINT_EXIT_CODE=$?

cd ..
git diff --name-only > /tmp/after_pint

PINT_MODIFIED=$(comm -13 /tmp/before_pint /tmp/after_pint)

if [ -n "$PINT_MODIFIED" ]; then
    echo "Pint has modified files, adding them to commit:"
    echo "$PINT_MODIFIED"
    echo "$PINT_MODIFIED" | xargs git add
fi

rm -f /tmp/before_pint /tmp/after_pint

cd api

if [ $PINT_EXIT_CODE -ne 0 ]; then
    echo "‚ùå Pint failed"
    exit 1
fi

echo "Running PHPStan..."
if ! vendor/bin/phpstan analyse --memory-limit=2G; then
    echo "‚ùå PHPStan failed"
    exit 1
fi

cd ..

echo "Checks passed"
exit 0